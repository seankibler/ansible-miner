---
- hosts: miners
  become: true
  vars:
    xmr_stak_donate: true
    update_xmr_stak: false
    monit_cycle: 300
    monit_services:
      - name: xmr-stak
        type: process_by_name
        target: xmr-stak
        start: /usr/local/bin/start-mining monero
        stop: /usr/local/bin/stop-mining
        user: skibler
        group: skibler
      - name: xmr-stak-prometheus-exporter
        type: process_by_name
        target: xmr-stak-prometheus-exporter
        start: "/bin/sh -c '/usr/local/bin/xmr-stak-prometheus-exporter &'"
        stop: /usr/bin/killall xmr-stak-prometheus-exporter
        user: root
        group: root
    xmr_stak_currencies:
      - monero
    xmr_stak_configs:
      monero:
        pool: "{{ xmrstak_vault.monero.pool }}"
        wallet: "{{ xmrstak_vault.monero.wallet }}"
        password: "{{ xmrstak_vault.monero.password }}"
  tasks:
    - user:
      args:
        name: skibler
        append: yes
        groups: ["sudo", "adm"]

    - authorized_key:
      args:
        user: skibler
        key: https://github.com/seankibler.keys

    - name: Passwordless sudo
      lineinfile:
        path: /etc/sudoers
        backup: yes
        line: "%sudo   ALL=(ALL) NOPASSWD:ALL"

    - name: Checkout amdmeminfo
      git:
        repo: https://github.com/ystarnaud/amdmeminfo
        dest: /usr/local/src/amdmeminfo
        update: no

    - name: Compile amdmeminfo
      make:
        chdir: /usr/local/src/amdmeminfo

    - name: Install amdmeminfo
      copy:
        dest: /usr/local/bin/amdmeminfo
        src: /usr/local/src/amdmeminfo/amdmeminfo
        force: yes
        mode: 0755
        owner: root
        group: root
        remote_src: True

    - name: Download ohgodatool
      get_url:
        url: https://github.com/OhGodACompany/OhGodATool/releases/download/1/ohgodatool
        dest: /usr/local/bin/ohgodatool
        owner: root
        group: root
        mode: 0755
        checksum: sha256:e8eb1a2fe939cabc959011f962ffe80a78ea7ebe10c29b085947b7f372731f9b

    - name: Install xmrstak prometheus exporter
      get_url:
        url: https://github.com/seankibler/xmr-stak-prometheus-exporter/releases/download/v1.0.0/xmr-stak-prometheus-exporter
        dest: /usr/local/bin/xmr-stak-prometheus-exporter
        owner: root
        group: root
        mode: 0755
        checksum: sha256:d64fa8bfe372256bb635060e09b1d2c78f0c961bb08a20ba50e4a508955806ad

  roles:
    # - seankibler.amdgpu-pro
    - xmr-stak
    - pgolm.monit
