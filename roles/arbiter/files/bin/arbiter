#! /usr/bin/env php

<?php

const CRIT_CPU_TEMP = 74;
const CRIT_GPU_TEMP = 85;

$temps = json_decode(file_get_contents("http://localhost/temperatures.php"));
$cpu_cores = $temps->cpu->cores;
$gpus = $temps->gpu;

function stop_mining() {
	system("killall xmr-stak");

	exit(0);
}


echo date('Y-m-d H:i:s') . ": ";

for($t=0; $t < count($cpu_cores); $t++) {
	if ($cpu_cores[$t] >= CRIT_CPU_TEMP) {
		echo "CPU Core " . $t . " violates max temp at " . $cpu_cores[$t] . "C, shutting down mining!";
		stop_mining();
	}
}

echo "CPU pass...";

for($t=0; $t < count($gpus); $t++) {
	if ($gpus[$t] >= CRIT_GPU_TEMP) {
		echo "GPU " . $t . " violates max temp at " . $gpus[$t] . "C, shutting down mining!";
		stop_mining();
	}
}

echo "GPU pass...";

exit(0);
